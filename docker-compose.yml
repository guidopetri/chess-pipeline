version: "3"

x-chess-pipeline-service: &chess-pipeline-service
  restart: no
  depends_on:
    - luigi_server
    - chess_pipeline_postgres
    - valkey
  volumes:
    - chess_pipeline_logs:/logs
    - .luigi_env:/app/luigi.cfg
  networks:
    - mainnetwork

services:
  chess_pipeline:
    <<: *chess-pipeline-service
    container_name: chess_pipeline
    image: chess-pipeline

  chess_pipeline_dev:
    <<: *chess-pipeline-service
    container_name: chess_pipeline_dev
    image: chess-pipeline-dev

  luigi_server:
    image: ghcr.io/guidopetri/luigi-server:master
    container_name: luigi_server
    restart: always
    depends_on:
      - chess_pipeline_postgres
    ports:
      - "127.0.0.1:8082:8082"
    env_file:
      - .luigi_env

  chess_pipeline_postgres:
    image: postgres:16-alpine
    container_name: chess_pipeline_postgres
    restart: always
    ports:
      - "127.0.0.1:5432:5432"
    env_file:
      - .postgres_env
    networks:
      - mainnetwork
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db:/sql_scripts:ro
      - ./db/initdb:/docker-entrypoint-initdb.d:ro

  valkey:
    image: valkey/valkey:alpine
    container_name: valkey
    restart: always
    networks:
      - mainnetwork
    ports:
      - "127.0.0.1:6379:6379"

volumes:
  chess_pipeline_logs:
  postgres_data:

networks:
  mainnetwork:
    external: true
